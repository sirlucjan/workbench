# Maintainer: Piotr Gorski <lucjan.lucjanov@gmail.com>
# Maintainer: Giancarlo Razzolini <grazzolini@archlinux.org>
# Maintainer: Dave Reisner <dreisner@archlinux.org>
# Maintainer: Thomas BÃ¤chler <thomas@archlinux.org>

pkgname=mkinitcpio-lucjan
_pkgname=mkinitcpio
pkgver=31
pkgrel=8
pkgdesc="Modular initramfs image creation utility"
arch=('any')
url='https://github.com/archlinux/mkinitcpio'
license=('GPL')
depends=('awk' 'mkinitcpio-busybox>=1.19.4-2' 'kmod' 'util-linux>=2.23' 'libarchive' 'coreutils'
         'bash' 'binutils' 'diffutils' 'findutils' 'grep' 'filesystem>=2011.10-1' 'zstd' 'systemd')
makedepends=('asciidoc')
optdepends=('gzip: Use gzip compression for the initramfs image'
            'xz: Use lzma or xz compression for the initramfs image'
            'bzip2: Use bzip2 compression for the initramfs image'
            'lzop: Use lzo compression for the initramfs image'
            'lz4: Use lz4 compression for the initramfs image'
            'mkinitcpio-nfs-utils: Support for root filesystem on NFS')
replaces=('mkinitcpio-zstd')
provides=('initramfs' 'initramfs-lucjan' 'initramfs-zstd' "mkinitcpio=$pkgver")
conflicts=('mkinitcpio')
backup=('etc/mkinitcpio.conf')
source=("https://sources.archlinux.org/other/$_pkgname/$_pkgname-$pkgver.tar.gz"{,.sig}
        '0001-Merge-mkinitcpio-libalpm-scripts-into-one.patch'
        '0002-functions-allow-tailing-for-custom-kernel-build-upon.patch'
        '0003-Fix-ability-to-manually-specify-uefistub.patch'
        '0004-Add-support-for-post-generation-hooks.patch'
        '0005-Allow-overriding-hooks.patch'
        '0006-mkinitcpio-add-VERSION_ID-to-EFISTUB.patch'
        '0007-functions-no-progress-for-zstd-decompression.patch'
        '0008-mkinitcpio-Support-etc-kernel-cmdline.d.patch'
        '0009-presets-when-using-_efi_image-make-_image-optional.patch'
        '0010-Revert-functions-no-progress-for-zstd-decompression.patch'
        '0011-add-zst-compressed-firmware-support-fpr-future-kerne.patch'
        '0012-add-real-symlink-support.patch'
        '0013-add-real-symlink-support.patch'
        '0014-add-MODULES_DECOMPRESS-switch.patch'
        '0015-fix-reproducibility-in-case-of-var-cache-is-included.patch'
        '0016-Good-idea-add-the-default-value.patch'
        '0017-mkinitcpio-improve-MODULES_DECOMPRESS.patch'
        '0018-Replace-check-with-rm-f.patch'
        '0019-Fix-typo-in-commit-reproducibility.patch')
install=mkinitcpio.install
sha512sums=('4ef87c2e4f579b292c38f9c487e78b3b99f6db77909cab322e860e5ca70aca3747fcfc272e2e15c9a3605c924ab178057b8b23151f98debc5d96e65f3c0c49d5'
            'SKIP'
            '130e941b869e1fd252cde6ce4fe9402a3feb399025635d7cc7718a83d5695decf7586624da00e0e7c6a8d57884f9483970e67c836f95f137075c87ffd5588b7b'
            '39a5ecd0b1c42f66c70dbb23b9251d40aebf803c1f651b14ecdd881765d7d0936003c92509c6259f6860c93167d59f2fd76cb37bb2e8fb567960e903a85ee7d3'
            '24e20ad568d3ecc9a542e628f57ad2c86591e21e4fbd2f5eb686815a549c7acf1e1b37e20931613069eb8cfe387a71f92059fca9e01f3199b981d650963ff0fa'
            '9508eda763c552c269e5c60c6faf6ec55eb9fcb03cfca8b3f708f2a3fe6f6c87bfc6cac6ee8ab831bb148c7601e027a496d47ad51def72893468cd92bf166ed8'
            '97086a10b169586da22698ee5590b7d42a49f05dd6b52a5c2fcff307f024db0ca2761bbed1c6d00bbd0037af75c8299d406f3b2a0ded9332159610f17ca79ed0'
            'b19db5c432bc7f4d4cd4514435f16e7de144bbc9244b20b38422fc9db50c01dd8a81b9388fc49b99aaabb592d41b41dea9f5add7f42afef24def4d87a4df3d85'
            'f335f4e48190573a8e75c1f63a71e6319369769e8877bedff70e842eb7b46f1a33e2e597024b959ae1eca7d6626ec4dae6757f1b71e6cadb6cdcfe2ccff75480'
            '3abbe25c0479676d1720c3c72af78247dd7ee1a76c6583f74a91348dd4fccd03b68a2e806a42542d5520c8b142cf65cd291d9b61c95f22b23e91075d5e04bc76'
            'c4a59272ecc9d10cef9821274bc2fbd3ccd63c30bcf0ad089309efcdb73dff32029f04b2b00389a337916e6af15233899d3556e97a3f5bd542c76b0f2b9eff57'
            '4fe8c07b51ef2178c3a8006e728ac425a372abb47bf4726420d62be328d16a5cac302eb0b894d24064ff371efc1f1022c90bd4affa7a29ce0ad66a26a7f75898'
            '7c9a0f7de9752ab3b7c3801f2bcccfb116ea6aea26b387ea8f086b76de7f9d1aa6c7b1734bf8bd51d7355de01c039e02756049dc80ab2c347e97fe5c7c991b01'
            '255bbd972ef6129e4aa797ed1e50a69f6e975aa45c839a51c97fd9a6555d854d583edde12c1c36a1879cd87e8700c4e683fdff92528f3fa0c7eb95eb7830560c'
            '53d015b6762c4e8ee4249567d063109afcb6836a4eacc8dfd360bc1bda543790b71ebe2a3b944403222ce6ca0898b9383d899ef4915da9835091060729576aa9'
            '73a55a02f046412f2d41d13687eab925c17ee605fb9bcd024943151582b26529a5347648dbcb29dc1010bc5353e1e3f48ac0b3f7278aeb1aa9176b22516e71ec'
            'dcbb86e57c9600bbc597f301a6d7d273c323245f568b4ac490e596fb2f304cb75b5c608d159de63d92a6dbba226e6871b74a30863cf6637c83ac090feae00667'
            'cb1f146266eebd8230f2b1b6f931484f171e1e3a9a4dc77aff62a82c15e881201cda1d0c76300b8a37619f2894018dc5e56c36640b898d2d069cf92fa5dafc48'
            '993731a02c27eb96fab6f858d9e5d36073b9ea293c898edc39197304bf686053f2b92c977ab26a0fe2e2a321eb8059c3a7d5267619ce0c2c3b8a700cbc302d7a'
            '787ce4d4ee3154f26ee37f6e94090a05f467490a6c1fe2e0a3cd32b11ba88366789622791e1d1dc9d7afae2d585908ef66b9430de60463a2f66eaeec6adcc8a7'
            '464ebbb144f5d94b8c371df0643ca0f46d02ba57eba86436e8dca8bb350785a2bbe44b840567e77c46a76065cda69c46ea0644b1c961679a779891dc9a7f96dc')
b2sums=('0113e288906e3b5fa485c29c00e7df60d85addd96718c45531031a686f18c739fa18303b6cac374d35b85edb7b663e221c8dc9158dff08c75858a4ed4dd154bf'
        'SKIP'
        'cc9696aeadae37850f2af4e8388c79563daac4cb8cb24a5ea54598ef7d9a2824ab9b6fa997bc7074cfa9488d55d8378c1b2441bcc14f0a6525544bd711066588'
        '699bf710e7fe71bff320669ba1e0f8caa2c274cc49d91e21260da860e4ecf4a37679d1fa6578b2add21f94e10a5f99a9483160b0a723e6084d50bb006c9b6724'
        '8cf7f3c8d9d6ee8166dc91b14864d7f0108c3d6cb9b419d9e3e4814d6d8a99d1175ee67e32d700fe72a13d134b9cd012c611eb2ba0e495550311c4099c732cac'
        '3a0cf26a39e210c13b061b7ae3538686a4b26f98b445ea483c04183e2d401713aa8076702face6c191686ef340a09a0a0255a98a1fd6fe06075c9439a9c44425'
        'bf6c5741422a9685a85cb63e75dbf14eda73be9bd4f9d40e4db64ceb93559d966359ad81a23b18d4dd36341e3b477d49ff6fa6492649bda1b0c11a96276b0228'
        'b73967dd6bb7044c995bfe50b41fe7a9d8785b17563d31e4967472115f7e3d9eee1eb9bdfdb21bd8f1117aa2b381f455e1b67941c892b3c7557ff450cb0013e5'
        '97a667601ba8321d3ac3ba233c3a84fc3195d5ced1306a7c2a5bd59e61433a3fc89ba657096d6621fb4a56509427ac94bf78a66dd4b323066dd5094f4f33b3ef'
        '046ff50b8dcfbf42e4dd19d6d8661ef8f7343bcab71c3ed9a3e93c9dc16a4524d4638c3d6e28988ba4a684a51e5b22f01fb7157689e2c8ef4c24854881a933a6'
        '21f1d45e468246942e74e1548382f84fef773baf667a4094853e2587f49453f71410ac94df4fb739a2be18eae15999ece3ed7565cf86e8684abbf53297c9f506'
        '72eb7df97d9dd67d315729ecc2471751482b3d8bd064b29b79b345cfdf1e48ee09014e17f6aebaa3553cae27770f251fc757925a9c93bcd0cd43bc7dc4278d37'
        'ed1d542a784170057272466a944dccb41fb73883958c0ba7ed22c540a08dd9cc3816dcd867440ad193b16ca80a1f84ef9cd6fd5e20b828c85da25b950ae5dc30'
        '8a825afff065cc735cc172a2d298e1d2510773f6177d28304766bc0bb947a76e217358c52c11cbcd4d08409be2845335fb6fa821093991a25d829b35e83c581e'
        'd89683df89e28aa8af45c7a27da674572af256ed0e5d4b52862f705455a7325eb72af5ed098ce5adb59f71e1f9a5e5ec5e22869700c2eacbd7b5ebe493173861'
        '41c655b6e6707b93e96dc9b606e4083a017fc43caea07f28002618768c2dcac0dbf590fcf8e78b942006ed1089650d648f3a1d980096751b3fd0c9fa29eb05eb'
        '7d5e761e0eee27208ba9b6481b2e137c25b63a23fba6793a328380b2b80cd742a1eb20cef62f6c8dd30abcffccd524d953a8ad564a042885cd01715a728d9b8e'
        'e9bfe3169f62ca355eb093c3a9af4d95bd87b83cdcb8d38935b9c3c7689809df867e4141f8abfbfa9bc2c63a1c65930cb7b1a680afd8fc02832ec4e39300deba'
        '7f919f951d661dec6e609e919037d6c06ab155445c64a8b46277145a564a97a7ead625744e0ceae0a20041e1a21e759f416bb08e54dd8d1f6189f086c5f07e90'
        '16447642fcf5da2d07c522cf75fed727871b1486c54a3124740c24b2b80160c17e84d6abf7809134ae43742e970a5dfd416a04b50f7ed15733f5208915cd04cf'
        'c0deb47e9c4d055444fc591c6a67494575f0bf88d04967b2f93067034771195a13ba116985e6c9c1d621f6e10ea61909ec687533f79bed4c71078c50f1ee12ec')
validpgpkeys=('ECCAC84C1BA08A6CC8E63FBBF22FB1D78A77AEAB')    # Giancarlo Razzolini

prepare() {
 cd $_pkgname-$pkgver

 local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done
}

check() {
  make -C "$_pkgname-$pkgver" check
}

package() {
  make -C "$_pkgname-$pkgver" DESTDIR="$pkgdir" install
}
