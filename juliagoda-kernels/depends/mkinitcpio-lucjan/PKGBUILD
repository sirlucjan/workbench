# Maintainer: Piotr Gorski <lucjan.lucjanov@gmail.com>
# Maintainer: Giancarlo Razzolini <grazzolini@archlinux.org>
# Maintainer: Dave Reisner <dreisner@archlinux.org>
# Maintainer: Thomas BÃ¤chler <thomas@archlinux.org>

pkgname=mkinitcpio-lucjan
_pkgname=mkinitcpio
pkgver=31
pkgrel=7
pkgdesc="Modular initramfs image creation utility"
arch=('any')
url='https://github.com/archlinux/mkinitcpio'
license=('GPL')
depends=('awk' 'mkinitcpio-busybox>=1.19.4-2' 'kmod' 'util-linux>=2.23' 'libarchive' 'coreutils'
         'bash' 'binutils' 'diffutils' 'findutils' 'grep' 'filesystem>=2011.10-1' 'zstd' 'systemd')
makedepends=('asciidoc')
optdepends=('gzip: Use gzip compression for the initramfs image'
            'xz: Use lzma or xz compression for the initramfs image'
            'bzip2: Use bzip2 compression for the initramfs image'
            'lzop: Use lzo compression for the initramfs image'
            'lz4: Use lz4 compression for the initramfs image'
            'mkinitcpio-nfs-utils: Support for root filesystem on NFS')
replaces=('mkinitcpio-zstd')
provides=('initramfs' 'initramfs-lucjan' 'initramfs-zstd' "mkinitcpio=$pkgver")
conflicts=('mkinitcpio')
backup=('etc/mkinitcpio.conf')
source=("https://sources.archlinux.org/other/$_pkgname/$_pkgname-$pkgver.tar.gz"{,.sig}
        '0001-Merge-mkinitcpio-libalpm-scripts-into-one.patch'
        '0002-functions-allow-tailing-for-custom-kernel-build-upon.patch'
        '0003-Fix-ability-to-manually-specify-uefistub.patch'
        '0004-Add-support-for-post-generation-hooks.patch'
        '0005-Allow-overriding-hooks.patch'
        '0006-mkinitcpio-add-VERSION_ID-to-EFISTUB.patch'
        '0007-functions-no-progress-for-zstd-decompression.patch'
        '0008-mkinitcpio-Support-etc-kernel-cmdline.d.patch'
        '0009-presets-when-using-_efi_image-make-_image-optional.patch'
        '0010-Revert-functions-no-progress-for-zstd-decompression.patch'
        '0011-add-zst-compressed-firmware-support-fpr-future-kerne.patch'
        '0012-add-real-symlink-support.patch'
        '0013-add-real-symlink-support.patch'
        '0014-add-MODULES_DECOMPRESS-switch.patch'
        '0015-fix-reproducibility-in-case-of-var-cache-is-included.patch')
install=mkinitcpio.install
sha512sums=('4ef87c2e4f579b292c38f9c487e78b3b99f6db77909cab322e860e5ca70aca3747fcfc272e2e15c9a3605c924ab178057b8b23151f98debc5d96e65f3c0c49d5'
            'SKIP'
            '6e50dbf9bc6cd2f61a04e2054890346606bbb9baa3eaad02d0fa87942f21384c2b7b5232c8f46351f48690e75e9d4436d665be02df6315e1ea84f27a9752764b'
            'f963ae31c2e5fc502d95f05012c7a1909350aaf308350f1ceb6be2c503b81cf2c03a512725c252d896b42026d597b40ff07d501ea670723c42b364437ceb1c40'
            '17c2b46406ae70a5344d60eb9c14170b719ca50ca0f077a9add7dd62fc0f367455c18e8fff2106117ba88bb2def54cfec39a4c5a49aadc6927129441c76ce6e9'
            '40583fcd42c0a2b5d47d8c904c1ae19e467c742f734a7bde91f5fdbb14df4e5b44821225c7a4eb3097684a125786025e022689bba6dbad0b635685da5aac9f13'
            '40d5f33c64a261a135023e3964d63350180f4ea5b8915e6796a1ee80c4708f456ee497f355cec4234285f1b6db91fda283ec74fab78096abc12b7d881d1999ac'
            'd57747eab337c9ac5ad0557c51c90cea62425ae0f972aea78ac29357ace26b76ca756e24f87d06984e67e4e6ec2579089bf65f9d2a45407b5d46506918187b19'
            '165895febebc808eb22c56f6113ef867d092ecc3ff94f09b934483ecf96a0aae79ccfcd28e795110eea38027633ac503ac7c37b7d549d540c6a2dd7f37e3b2eb'
            'aa4190ee5145d313f784014c4b1e1a5cefa6b3416cce813b93a941d664289ca77d797c9413bbb261980800e3cd6c82e919c2d8ca100df68d72d9a58adda88064'
            'bbfae4533d5d67e39ec66260f53941e8ab9201ebe1985185f82bb17e3b43a10fc345f845aba13bba6eab01ade72b4054912f009035e81803e5252f1225464309'
            '8f97ba9d11dbc876ca9f3fde0b5fd18163835caa7d2610f47babaf62b2e5f553dd6d13a80fd9366ace986faa1479a1a219424ba54981abf23c557e6353c1f6a1'
            '0757f01fd3384cce8ce900461a64ec3ccc8f991eaa6f25bf1e81b081f2829aae794d8d7e724ddba5d2b5bae294ccb4253117d1e2cfcecd123b392bf0d257d642'
            '736af4b014a9ec75d84939e6cf8fa90db702eceaa144809c9bab62cbc10ffca2fe00fe7ce3ddca8e458533fb1702be6d75bf98a42f451edbcc8b174471a871da'
            '035d5f4a3b2ec28e23b5eae2b0d0c1e6071c230946589594983798b64b8cabbb54e09d1e3e25adda5a9e662d92f046c617f3af68a0239de25bebb55b822d5292'
            'dedf4343e0ac52664c7524943d38fb8e39a591dfefe3e65a1ec8c13f7d8b019c34e62bd2158ade7d65ff207d9058b11816a063e6e934e9a13b92a07dc9c98119'
            '367ef748faa9d0b4fb58d0c8474ad6eabb447828024ab5c25c13f0fe2ca1477b24810c4c410a9f786b999d588522ab27e7c8cf936e7bdf1758838f22aa0663ad')
b2sums=('0113e288906e3b5fa485c29c00e7df60d85addd96718c45531031a686f18c739fa18303b6cac374d35b85edb7b663e221c8dc9158dff08c75858a4ed4dd154bf'
        'SKIP'
        '090df3a69648c92517f3cf493c0766b8eeca39bd0787482af8543be63020ae90308ed614d459e3f4d2b7afaa80bc159f4c5aa29956d5b2bca59bb03ce2250ab5'
        '393287c5f453439df5a65b2c54b0ce303793ef0847d9615d974d2f07dd04c8f7751fff5ba1eea066cfe60b6bac64209206f50d99beca485c1e1f6955f5ffa43c'
        '4f64fd19fd060e2afd7fbe15fb9a082a85c2508728de59f1e9c92bfd1b165fea576eb608b23a485b6c7261a49b91be4b4d663ebb00200e2baeb9f8817cb7c44a'
        '9acd47d599f07655e72346daedfa398fb37d3399344440c657d308970422b93e988e988de39d176e86508c9e04a1e0a8797c68e002d47c15fc18b5472603684b'
        '6a9774f1a7901d0959ebb076058cdf8fe9c9fe3d6f42115f39121094ec1e8f513580bb8e6673488a2332bef40eb3ce7cd5775837ecfd7002d83c41d233c3484a'
        '0bd810071a54bc86208fcaf5338228413c5406e947774379f2fb048953d179049729b4f3a0feb18657a9d754eddb730f5f3ec5dcbc4c63ab552945841645fe97'
        'e66b6c9946220d73b702f5257904084d2812cebcfc4620261997f479016331d02039227eced1e4b4aea5b85b9d92417e19e5eb72c300a0a8f4fa1f6898c7dec1'
        '3c2e436f67c87d78b9a6212f9aa2fa297273b1bb2376ebcc739e191aad3e9d29dc2aee60b9c69c55b31633cd5ded90db14afb5cd4012cb4c68a9f65a6aed8616'
        'a7c397705c0f133df0eaba2e87955732f8893859570fa7dbbab1daf14712ef3c881968d6a4041ba8fae4242de104c902861c5cb4636b4bc3c9dfe9a614026f5f'
        '26051ac9ef2c1bbe69b7e154e109f390d7d0b39d05c58f1da98e8fa4571cfd8301d640f766c3817d6753a4a733108bec489c337033a1e155417ea42218b49714'
        '970b457600a6af9400d873fb9ed12578c4120007bc8d993e1d94215b05188a423b7ff3bfdd60520cae8adfc8c6755d2219010af31cd2db8b9294068679f99cee'
        '2b8cba07a5312ca2f93c2a51a79a7c688db36463de3637bb73a829063c8d960f4654fc901212f9d0764171876696bdcd230df2fe09b6920fee7959d84adfbf02'
        '51ae9b10c3eaefec194014ee10fb1947014f8e70603a90fa3d51fe3faf7c18e24f11ea8faf1224808da2b490ddb2afa60492fa38b47185a1b3c439f358b87128'
        '85f6b1c8d904fdbdb05b740fc6012f1561d8f690d5178d879cf792dafdcda80e122d8a3417233726a4c13fd2ee33d0d7fe93b95888163e5dc858dbe85b64b9ba'
        '5ada70508601c82226c07402be04b4810db091641f7b4e3a57113a726eae936dcbaddcac4013a87152d8db6c3ab4851930b5cf56c11a9a6d1f66a94dfe39a419')
validpgpkeys=('ECCAC84C1BA08A6CC8E63FBBF22FB1D78A77AEAB')    # Giancarlo Razzolini

prepare() {
 cd $_pkgname-$pkgver

 local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done
}

check() {
  make -C "$_pkgname-$pkgver" check
}

package() {
  make -C "$_pkgname-$pkgver" DESTDIR="$pkgdir" install
}
